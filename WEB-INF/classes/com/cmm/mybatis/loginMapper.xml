<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 별명지정(중복만 안되면 됨) -->
<mapper namespace="test">

	<!-- resultType:sqlmapConfig.xml에서 알리아스설정때문에 간단히씀 -->

	<select id="login" parameterType="map" resultType="UserDto">
		select * from user_tbl  where user_id=#{user_id} and password =#{password}
	</select>
	<select id="checkId" parameterType="String" resultType="int">
		select count(*) from user_tbl where user_id=#{user_id}
	</select>
	 <select id="checkAdmin" parameterType="String" resultType="int"> 
	     select permission from user_tbl where user_id=#{user_id} 
	</select> 
	<select id="userInfo" parameterType="String" resultType="UserDto">
	    select DATE_FORMAT(last_logout, '%Y-%m-%d %H:%i') lastlogout,a.* from user_tbl a where a.user_id=#{user_id}
	</select>
	
	<update id="lastLogout" parameterType="String" >
	    update user_tbl set last_logout = sysdate()
	    where user_id = #{user_id}
	</update>
	<update id="updateProfile" parameterType="UserDto">
		update user_tbl set email=#{email}, telephone=#{telephone}, address=#{address}, memo=#{memo}
				where user_id=#{user_id}
	</update>
	
	<select id="getUlist" resultType="UserDto">
	   select * from user_tbl; 
	</select>
	<update id="adminUpdate" parameterType="UserDto">
	    update user_tbl set permission=#{permission}, name=#{name} where iseq = #{iseq}
	</update>
	
	<insert id="signUp" parameterType="UserDto">
		insert into user_tbl(iseq,user_id,password,name,email,telephone,address)
		select case count(*) when 0 then 1 else max(iseq) + 1 end,#{user_id2},#{password2},#{name},#{email},#{telephone},#{address} from user_tbl
	</insert>	
	
	<!-- 게시판 -->
	<!--  select 시작 -->
	<select id="boardList" resultType="BoardDto" useCache="true">
		select * from board_tbl order by pos asc
	</select>	
	<select id="boardSearch" parameterType="map" resultType="BoardDto">
		select * from board_tbl where ${keyfield} like '%${keyword}%' order by pos asc
	</select>
	<select id="findBySeq" parameterType="int" resultType="BoardDto">
		select * from board_tbl where seq = #{seq}
	</select>
	<select id="preView" parameterType="int" resultType="String">
		select content from board_tbl where seq = #{seq}
	</select>
	<select id="getUser" parameterType="int" resultType="BoardDto">
	    select * from user_tbl where iseq = #{iseq}
	</select>
	<!-- select 끝 -->	

	<!-- 본문 읽기 시작-->
	<update id="readCount" parameterType="int">
		update board_tbl set count = count + 1 where seq = #{seq}
	</update>
	<update id="upPos">
		update board_tbl set pos = pos + 1
	</update>
	<!--  본문 읽기 끝 -->

	<!-- 글쓰기 시작 -->
	<insert id="insertBoard" parameterType="BoardDto">
	<!-- 		insert into board_tbl(seq,name,email,homepage,title,content,password,
		count,regdate,pos,depth) values(seq_num.nextval,#{name},#{email},#{homepage},#{title},#{content},#{password},0,sysdate,0,0) -->
		insert into board_tbl(seq,name,email,homepage,title,content,password,count,regdate,pos,depth,iseq)
		select case count(*) when 0 then 1 else max(seq) + 1 end,#{name},#{email},#{homepage},#{title},#{content},#{password},0,curdate(),0,0,#{iseq} from board_tbl
	</insert>	
	<!-- 글쓰기 종료 -->	

	<!-- 글수정 시작 -->
	<update id="updateBoard" parameterType="map">
		update board_tbl set title=#{board.title}, content=#{board.content}, email=#{board.email}, name=#{board.name}
				where seq=#{board.seq} and password=#{password} 
	</update>
	<!-- 글수정 종료 -->

	<!-- 글삭제와 넘어가는 화면 -->
	<select id="deleteView" parameterType="int" resultType="String">
		select password from board_tbl where seq=#{seq}
	</select>
	<delete id="deleteBoard" parameterType="map">
		delete from board_tbl where seq=#{seq} and password=#{storPass}
	</delete>
	<!-- 글삭제 종료 -->

	<!-- 답변달기와 넘어가는 화면 mysql버전은 주석처리 -->
	<insert id="replyBoard" parameterType="BoardDto">
	<!-- 		insert into board_tbl(seq,name,email,homepage,title,content,password,count,regdate,pos,depth)
		values(seq_num.nextval,#{name},#{email},#{homepage},#{title},#{content},#{password},0,sysdate,#{pos}+1,#{depth}+1) -->
		insert into board_tbl(seq,name,email,homepage,title,content,password,count,regdate,pos,depth)
		select case count(*) when 0 then 1 else max(seq) + 1 end,#{name},#{email},#{homepage},#{title},#{content},#{password},0,curdate(),#{pos}+1,#{depth}+1 from board_tbl			
	</insert>
	<update id="replyUpPos" parameterType="BoardDto">
		update board_tbl set pos = pos + 1 where pos>#{pos}
	</update>
	<!-- 답변달기 종료 -->


</mapper>